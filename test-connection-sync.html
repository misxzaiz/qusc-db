<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿æ¥åŒæ­¥æµ‹è¯•</title>
</head>
<body>
    <h1>è¿æ¥é…ç½®åŒæ­¥æµ‹è¯•</h1>
    
    <button onclick="saveTestConnection()">ä¿å­˜æµ‹è¯•è¿æ¥</button>
    <button onclick="deleteTestConnection()">åˆ é™¤æµ‹è¯•è¿æ¥</button>
    <button onclick="checkLocalStorage()">æ£€æŸ¥LocalStorage</button>
    
    <div id="log" style="margin-top: 20px; padding: 10px; background: #f5f5f5; max-height: 300px; overflow-y: auto;"></div>

    <script>
        // ç›‘å¬è¿æ¥é…ç½®æ›´æ–°äº‹ä»¶
        window.addEventListener('connections-updated', (event) => {
            log(`ğŸ‰ æ£€æµ‹åˆ°è¿æ¥é…ç½®æ›´æ–°äº‹ä»¶:`, event.detail);
        });

        function log(message, data = null) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            let logEntry = `[${timestamp}] ${message}`;
            
            if (data) {
                logEntry += '\n' + JSON.stringify(data, null, 2);
            }
            
            const p = document.createElement('p');
            p.style.margin = '5px 0';
            p.style.borderBottom = '1px solid #ddd';
            p.innerHTML = logEntry.replace(/\n/g, '<br>');
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function saveTestConnection() {
            const testConfig = {
                db_type: 'MySQL',
                host: 'localhost',
                port: 3306,
                username: 'test',
                password: 'test123',
                database: 'testdb'
            };
            
            // æ¨¡æ‹Ÿä¿å­˜è¿æ¥é…ç½®çš„è¿‡ç¨‹
            const saved = JSON.parse(localStorage.getItem('qusc-db-connections') || '{}');
            saved['test-connection-' + Date.now()] = testConfig;
            localStorage.setItem('qusc-db-connections', JSON.stringify(saved));
            
            // è§¦å‘äº‹ä»¶ï¼ˆæ¨¡æ‹Ÿæˆ‘ä»¬ä¿®æ”¹çš„ä»£ç ï¼‰
            window.dispatchEvent(new CustomEvent('connections-updated', {
                detail: { action: 'saved', name: 'test-connection', config: testConfig }
            }));
            
            log('âœ… æµ‹è¯•è¿æ¥å·²ä¿å­˜å¹¶è§¦å‘æ›´æ–°äº‹ä»¶');
        }

        function deleteTestConnection() {
            const saved = JSON.parse(localStorage.getItem('qusc-db-connections') || '{}');
            const keys = Object.keys(saved).filter(key => key.startsWith('test-connection'));
            
            if (keys.length > 0) {
                const keyToDelete = keys[0];
                delete saved[keyToDelete];
                localStorage.setItem('qusc-db-connections', JSON.stringify(saved));
                
                // è§¦å‘äº‹ä»¶
                window.dispatchEvent(new CustomEvent('connections-updated', {
                    detail: { action: 'deleted', name: keyToDelete }
                }));
                
                log('âœ… æµ‹è¯•è¿æ¥å·²åˆ é™¤å¹¶è§¦å‘æ›´æ–°äº‹ä»¶');
            } else {
                log('âŒ æ²¡æœ‰æ‰¾åˆ°å¯åˆ é™¤çš„æµ‹è¯•è¿æ¥');
            }
        }

        function checkLocalStorage() {
            const saved = JSON.parse(localStorage.getItem('qusc-db-connections') || '{}');
            log('ğŸ“‹ å½“å‰LocalStorageä¸­çš„è¿æ¥é…ç½®:', saved);
            log(`ğŸ“Š è¿æ¥æ€»æ•°: ${Object.keys(saved).length}`);
        }

        log('ğŸš€ è¿æ¥åŒæ­¥æµ‹è¯•é¡µé¢å·²åŠ è½½');
        log('ğŸ’¡ ç‚¹å‡»æŒ‰é’®æµ‹è¯•äº‹ä»¶è§¦å‘æœºåˆ¶');
    </script>
</body>
</html>